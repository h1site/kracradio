#!/bin/bash

# Script pour appliquer les migrations communautaires √† Supabase
# Usage: ./scripts/apply-migrations.sh

set -e

echo "üöÄ Application des migrations communautaires Kracradio..."
echo ""

# V√©rifier que supabase CLI est install√©
if ! command -v supabase &> /dev/null; then
    echo "‚ùå Supabase CLI n'est pas install√©."
    echo "Installation: npm install -g supabase"
    exit 1
fi

# V√©rifier que nous sommes dans le bon r√©pertoire
if [ ! -f "package.json" ]; then
    echo "‚ùå Erreur: ce script doit √™tre ex√©cut√© depuis la racine du projet"
    exit 1
fi

# Cr√©er le dossier migrations s'il n'existe pas
mkdir -p supabase/migrations

echo "üìã Migrations √† appliquer:"
echo "  1. 001_community_profiles.sql - Profils, music links, follows"
echo "  2. 002_posts_and_feed.sql - Posts, r√©actions, commentaires"
echo "  3. 003_notifications_moderation.sql - Notifications, blocage, reports"
echo ""

read -p "Voulez-vous continuer? (y/n) " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå Annul√©"
    exit 1
fi

echo ""
echo "üîó Connexion √† Supabase..."

# Option 1: Appliquer via psql directement
if [ -n "$DATABASE_URL" ]; then
    echo "üìä Application via DATABASE_URL..."

    for file in supabase/migrations/*.sql; do
        if [ -f "$file" ]; then
            echo "  ‚ñ∂ $(basename $file)..."
            psql "$DATABASE_URL" -f "$file"
        fi
    done

# Option 2: Via Supabase CLI
else
    echo "üìä Application via Supabase CLI..."
    echo "‚ö†Ô∏è  Assurez-vous d'√™tre connect√© avec: supabase link --project-ref XXX"
    echo ""

    for file in supabase/migrations/*.sql; do
        if [ -f "$file" ]; then
            echo "  ‚ñ∂ $(basename $file)..."
            supabase db push --db-url "$SUPABASE_DB_URL" < "$file"
        fi
    done
fi

echo ""
echo "‚úÖ Migrations appliqu√©es avec succ√®s!"
echo ""
echo "üìù Prochaines √©tapes:"
echo "  1. V√©rifier les tables dans le dashboard Supabase"
echo "  2. Tester les RLS policies"
echo "  3. Cr√©er des donn√©es de test"
echo ""
echo "üí° Pour cr√©er des donn√©es de test:"
echo "   npm run seed:community"
echo ""
